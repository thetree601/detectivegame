"use client";

import { useState, useEffect, useCallback } from "react";
import { useAuth } from "@/contexts/AuthContext";
import {
  getUserCoins,
  initializeUserCoins,
  spendCoins as spendCoinsUtil,
} from "@/utils/coins";

interface UseCoinsReturn {
  balance: number;
  loading: boolean;
  error: string | null;
  refreshBalance: (newBalance?: number) => Promise<void>;
  spendCoins: (
    amount: number,
    purpose: "answer_reveal" | "case_unlock",
    relatedId?: number
  ) => Promise<{ success: boolean; error?: string }>;
}

export function useCoins(): UseCoinsReturn {
  const [balance, setBalance] = useState<number>(0);
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState<string | null>(null);
  const { getCurrentUserId, user } = useAuth();

  /**
   * ì½”ì¸ ì”ì•¡ ì¡°íšŒ ë° ì—…ë°ì´íŠ¸
   * @param newBalance ì„œë²„ì—ì„œ ì´ë¯¸ ê³„ì‚°ëœ ì”ì•¡ì´ ìˆë‹¤ë©´ ì§ì ‘ ì…ë ¥ ê°€ëŠ¥
   */
  const refreshBalance = useCallback(async (newBalance?: number) => {
    // ğŸ’¡ 1. ìƒˆë¡œìš´ ì”ì•¡ì´ ì§ì ‘ ë“¤ì–´ì˜¨ ê²½ìš° ì¦‰ì‹œ ì—…ë°ì´íŠ¸ (ê°€ì¥ ë¹ ë¦„)
    if (typeof newBalance === "number") {
      setBalance(newBalance);
      return;
    }

    setLoading(true);
    setError(null);

    try {
      const userId = getCurrentUserId();
      if (!userId) {
        setBalance(0);
        return;
      }

      // ì´ˆê¸°í™” ë¡œì§ (ë ˆì½”ë“œê°€ ì—†ì„ ë•Œë§Œ ìƒì„±)
      await initializeUserCoins(userId);

      // ì½”ì¸ ì”ì•¡ ì¡°íšŒ
      const coins = await getUserCoins(userId);
      setBalance(coins);
    } catch (err: unknown) {
      const errorMessage =
        err instanceof Error ? err.message : "ì½”ì¸ ì”ì•¡ ì¡°íšŒì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.";
      setError(errorMessage);
      console.error("ì½”ì¸ ì”ì•¡ ì¡°íšŒ ì¤‘ ì˜¤ë¥˜:", err);
      setBalance(0);
    } finally {
      setLoading(false);
    }
  }, [getCurrentUserId]);

  const spendCoins = useCallback(
    async (
      amount: number,
      purpose: "answer_reveal" | "case_unlock",
      relatedId?: number
    ): Promise<{ success: boolean; error?: string }> => {
      const userId = getCurrentUserId();
      if (!userId) {
        return { success: false, error: "ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤." };
      }

      const result = await spendCoinsUtil(userId, amount, purpose, relatedId);
      if (result.success) {
        await refreshBalance();
      }
      return result;
    },
    [getCurrentUserId, refreshBalance]
  );

  useEffect(() => {
    refreshBalance();
  }, [user?.id, refreshBalance]);

  return { balance, loading, error, refreshBalance, spendCoins };
}